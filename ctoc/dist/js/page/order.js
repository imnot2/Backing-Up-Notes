Ymt.add(function(a){function b(a,b){var e=b||$("#txtNum"),f=b&&b.val()||e.val();if(!$(a).hasClass("op_disabled")){if($(a).hasClass("add")){if(f++,d(f,1)||$(a).siblings(".del").removeClass("op_disabled"),c(f))return $(a).addClass("op_disabled"),alert("限购"+t+"件"),void e.val(--f);if(f==u&&$(a).addClass("op_disabled"),f>u)return $(a).addClass("op_disabled"),alert("库存不够"),void e.val(u);e.val(f)}$(a).hasClass("del")&&(f--,f=1>f?1:f,e.val(f),d(f,1)&&$(a).addClass("op_disabled"),c(f)||$(a).siblings(".add").removeClass("op_disabled"))}}function c(a){return t&&a>t}function d(a,b){return b>=a}function e(){var a=$("#txtNum").val(),b=$("#hidEarnest").val();parseInt(b)>0&&parseInt(a)>0?($("#needPayAmount").html(parseInt(b)*parseInt(a)),p($("#hidProductId").val(),parseInt(a),$("#hidSellerId").val())):$("#needPayAmount").html(0)}function f(){$.ajax({type:"get",async:!1,url:"/Order/Order/GetProductCatalogs?productId="+$("#hidProductId").val(),dataType:"jsonp",success:function(a){v=a.Result,g()},error:function(){}})}function g(){for(var a,b,c,d,e,f=0,g=v.length;g>f;f++)if(c=v[f].Catalog,null!=c&&void 0!=c){if(b=c.indexOf("@"),a=v[f].Catalog.slice(b+1).split(","),0==a.length)return;for(var j=0;j<a.length;j++)d=a[j].split(":"),e=d[1],d="k"+m(d[0]),w[d]=w[d]||[],w[d].push(e)}else(null==c||void 0==c)&&$("#hidCatalogId").val(v[f].CatalogId);for(var l in w)y+=1,w[l]=n(w[l]),h(w[l],l);k(x),i()}function h(a,b){for(var c,d=0,e=v.length;e>d;d++)for(var f=0;f<a.length;f++)v[d].Catalog.indexOf(l(b)+":"+a[f])>-1&&(c=m(a[f]),x[b]=x[b]||{},x[b]["v"+c]=x[b]["v"+c]||[],x[b]["v"+c].push(v[d].CatalogId))}function i(){$("#CategorySelect a[cid]").live("click",function(){if(!$(this).hasClass("disabled")&&!$(this).hasClass("hover")){$(this).closest(".item").find("a").removeClass("hover"),$(this).addClass("hover"),$("#CategorySelect").find("a").removeClass("disabled");var a=[],b=$(this).attr("cid").split(":"),c=x[b[0]][b[1]];for(var d in x)if(d!=b[0])for(var e in x[d])j(x[d][e],c)||a.push(d+":"+e);for(var f=0;f<a.length;f++)$("#CategorySelect").find('a[cid="'+a[f]+'"]').addClass("disabled");var g,h=$("#CategorySelect").find("a.hover"),i=this;h.size()==y&&(1==y&&$("#hidCatalogId").val(c[0]),2==y&&(h.each(function(a,b){b!=i&&(g=$(this).attr("cid").split(":"))}),$("#hidCatalogId").val(j(c,x[g[0]][g[1]]))))}})}function j(a,b){for(var c=0,d=a.length;d>c;c++)for(var e=0,f=b.length;f>e;e++)if(a[c]==b[e])return a[c];return!1}function k(a){var b,c=[];for(var d in a){b=l(d),c.push('<div class="item"><div class="cate-hd"><b class="label">商品'+b+"</b></div>");for(var e in a[d])c.push('<a class="btn-small" cid="'+d+":"+e+'" href="javascript:;">'+l(e)+"</a>");c.push("</div>")}$("#CategorySelect").html(c.join("")),$("#CategorySelect").css("display","block")}function l(a){a=a.slice(1).split("-");for(var b=0;b<a.length;b++)a[b]=String.fromCharCode(a[b]);return a.join("")}function m(a){for(var b=[],c=0,d=a.length;d>c;c++)b.push(a.charCodeAt(c));return b.join("-")}function n(a){for(var b=[],c=0;c<a.length;c++)-1==$m.indexOf(a[c],b)&&b.push(a[c]);return b}function o(){var a=$("input[name='couponItem']:checked").val();if($("#hidCouponsCode").val(""),$("#hidUseGiftlAmount").val(0),"GiftAvailAmount"==a)$("#hidUseGiftlAmount").val($("#hidGiftAvailAmount").val());else if("CouponsCount"==a){var b=$("input[name='codeItem']:checked").val();if(""==b||void 0==b)return alert("请选择优惠券！"),!1;$("#hidCouponsCode").val(b)}else if("CouponsCode"==a){var c=$.trim($("#txtCouponsCode").val());if(""==c||void 0==c)return alert("请输入优惠码！"),!1;$("#hidCouponsCode").val(c)}return!0}function p(a,b,c){""!=a&&b>0&&""!=c&&($("#couponItems").html(""),$.ajax({type:"get",url:"/Order/Order/GetUserAccountInfo?productId="+a+"&productNum="+b+"&sellerId="+c,success:function(a){if(200==a.Status){var b="",c="",d="",e="";cdisp="disabled",gdisp="disabled",$.each(a.Result,function(){var f="无可使用优惠券",g="可使用金额<i>&yen;</i><b>0</b>";parseInt(a.Result.CouponsCount)>0&&(f="<b>"+a.Result.CouponsCount+"</b>张优惠券可使用",cdisp=""),parseInt(a.Result.GiftAvailAmount)>0&&(g="可使用金额<i>&yen;</i><b id='availAmount'>"+a.Result.GiftAvailAmount+"</b>",$("#hidGiftAvailAmount").val(a.Result.GiftAvailAmount),gdisp=""),b='<div class="item" ><input type="radio" id=\'radionoAmount\' name="couponItem" value="NoDiscount"/><label class="label" for="radionoAmount">不使用任何优惠</label></div>',c='<div class="item '+gdisp+'" ><input type="radio" id=\'radioAvailAmount\' name="couponItem" value="GiftAvailAmount" '+gdisp+'/><label class="label" for="radioAvailAmount">使用红包</label><span class="price mr">'+g+"</span></div>",d='<div class="item '+cdisp+'"><input type="radio" id=\'radioCouponsCount\' name="couponItem" value="CouponsCount" '+cdisp+'/><label class="label" for="radioCouponsCount"> 使用优惠券</label><span>'+f+'</span> <ul class="couponlist" id="couponlist"></ul></div>',e='<div class="item"><input type="radio" id=\'radioCouponsCode\' name="couponItem" value="CouponsCode" /><label class="label" for="radioCouponsCode">使用优惠码</label><input class="code" id="txtCouponsCode" name="couponCode" type="text" value="" disabled=disabled/></div>'}),$("#couponItems").html(b+c+d+e)}}}))}function q(){var a=$("#hidSellerId").val(),b=$("#hidPrice").val(),c=$("#txtNum").val();b>0&&c>0&&""!=a&&$.ajax({type:"get",url:"/Order/Order/GetListUserCoupons?productPrice="+b+"&productNum="+c+"&sellerId="+a,success:function(a){if(200==a.Status){var b="";$.each(a.Result,function(a,c){b+='<li class="li"><input type="radio" id="couponcode'+a+'" name="codeItem" value="'+c.CouponCode+'"/><label class="price" for="couponcode'+a+'">'+c.CouponValue+"</label></li>"}),$("#couponlist").append(b)}}})}function r(){var a=$("#hidProductId").val(),b=$("#hidCatalogId").val(),c=$("#txtNum").val(),d=$("#hidAddressId").val(),e=$("#txtLeaveWord").val(),f=$("#hidUseGiftlAmount").val(),g=$("#hidCouponsCode").val(),h=$("#hidLimitedNumber").val(),i=$("#hidStockNum").val(),j=$("#hidBuyType").val();return"T"!=j?(alert("请勿重复提交订单"),!1):null==a||""==a?(alert("商品不存在"),!1):0>=c?(alert("请选择购买数量"),!1):0==b||""==b||void 0==b?(alert("请先选择规格"),!1):0>=d?(alert("请先设置收货地址"),!1):(e.indexOf("写下你的留言吧")>-1&&(e=""),0==parseInt(i)?(alert("库存已被无情的抢走了，其他小伙伴下单比你快哦！看看别的宝贝，继续加油咯！"),!1):parseInt(i)<parseInt(c)?(alert("该商品仅剩"+i+"件库存，请修改购买数量"),!1):parseInt(h)>0&&parseInt(c)>parseInt(h)?(alert("买手设置了此商品的购买数量限制，最多可购买"+h+"件"),!1):""!=a&&""!=b&&c>0&&d>0?void $.ajax({type:"POST",url:"/Order/Order/SaveOrder?productId="+a+"&CatalogId="+b+"&ProductNum="+c+"&AddressId="+d+"&LeaveWord="+e+"&UseGiftAmount="+f+"&CouponCode="+g,success:function(a){return 200!=a.Status?(alert(a.Msg),!1):($("#hidOrderId").val(a.Result),$("#hidBuyType").val("F"),self.location=$("#hidYmtUrl").val()+"/BuyerOrderPrepay/PreparePay?oid="+a.Result,void 0)}}):(alert("下单失败"),!1))}var s=a("module/component/address");s("#AddressList",{importAddrssCls:"#hidAddressId",addressApiHost:"",selectAddress:function(a){0==$(".userinfo .address").size()?$(".userinfo").html('<p>寄送至：<span class="address">'+a.Area+" "+a.DetailAddress+'</span></p><p>收件人：<span class="name">'+a.Addressee+'</span><span class="phone">'+a.Phone+"</span></p>"):($(".userinfo .address").html(a.Area+" "+a.DetailAddress),$(".userinfo .name").html(a.Addressee),$(".userinfo .phone").html(a.Phone))}}),$(".add-del-count").attr("unselectable","on").css({"-moz-user-select":"-moz-none","-moz-user-select":"none","-o-user-select":"none","-khtml-user-select":"none","-webkit-user-select":"none","-ms-user-select":"none","user-select":"none"}).bind("selectstart",function(){return!1}),e();var t=parseInt($("#hidLimitedNumber").val())||0,u=parseInt($("#Stock").text())||0;$("#txtNum").bind({keyup:function(){var a=/[^\d]|^0*/g;return $(this).val($(this).val().replace(a,"")),""==$(this).val()||$(this).val(parseInt($(this).val())),e(),!1},focus:function(a){this.select(),a.stopPropagation(),a.preventDefault()},mouseup:function(a){this.select(),a.stopPropagation(),a.preventDefault()},change:function(a){this.select(),a.stopPropagation(),a.preventDefault(),e()}}),$(".clearfix span").live("click",function(){b(this),e()});var v,w={},x={},y=0;$(function(){f()}),$("#validateBtn").click(function(){return o()?void r():!1}),$("#txtCouponsCode").live("blur",function(){var a=$(this).val();/[^a-zA-Z0-9]/g.test(a)&&(alert("请输入正确验证码"),$(this).val(a.replace(/[^a-zA-Z0-9]/g,"")))}),$("input:radio[name='couponItem']").live("click",function(){$("#couponlist").html(""),$("#txtCouponsCode").attr("disabled","disabled"),$("#txtCouponsCode").val("");var a=$("input:radio[name='couponItem']:checked").val();"CouponsCount"==a?q():"CouponsCode"==a&&($("#txtCouponsCode").removeAttr("disabled"),$("#txtCouponsCode").val(""))})});