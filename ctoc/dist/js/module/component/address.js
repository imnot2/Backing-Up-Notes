Ymt.add(function(a){function b(a,d){return this instanceof b?(this.container=$(a),this.config=d,void this.init()):new b(a,$m.merge(c,d))}var c={editAlertCls:"",tipsCls:"#__FloatAddressLayer .layer-tips",addCls:"#AddNewAddress",editCls:".edittrigger",delCls:"#__FloatAddressLayer .deladdress",importAddrssCls:"#hidAddressId",addAddressURL:"/Order/Order/AddReceiveAddresses",editAddressURL:"/Order/Order/EditReceiveAddresses",delAddressURL:"/Order/Order/DelReceiveAddresses",getAllAddressURL:"/Order/Order/GetAllReceiveAddresses",addressApiHost:""},d=a("module/widget/layerbox"),e=a("module/util/location"),f=null,g=d("temps",{Temps:'<div class="floatlayer" id="__FloatAddressLayer"><div class="layer-hd"><h2 class="h2">新增收货地址</h2></div><div class="layer-bd"><div class="layer-tips"></div><ul class="addressform" id="__SelectChinaArea"><li><label><span>所在地区</span><i>*</i></label><select name="Province"><option value="">{Province}</option></select><select name="City"><option value="">{City}</option></select><select name="County"><option value="">{County}</option></select></li><li><label><span>详细地址</span><i>*</i></label><input name="DetailAddress" type="text" value="{DetailAddress}" class="input-text" placeholder="不需要重复写省市区"></li><li><label><span>邮政编码</span><i>*</i></label><input name="PostCode" type="text" value="{PostCode}" class="input-text"></li><li><label><span>收货人</span><i>*</i></label><input name="Addressee" type="text" value="{Addressee}" class="input-text"></li><li><label><span>手机号</span><i>*</i></label><input name="Phone" type="text" value="{Phone}" class="input-text"></li><li class="default"><input type="checkbox" name="IsDefault" checked="{IsDefault}" class="input-checkbox" id="SetDefault"><label for="SetDefault">设为默认收货地址</label></li><li class="action"><input type="hidden" name="AddressId" value="{AddressId}" /><a AddressId="{AddressId}" id="___SubmitAddress" class="btn btn-buy">保存</a><a href="javascript:;" class="deladdress" AddressId="{AddressId}" >删除收货地址</a></li></ul></div><div class="layer-bt"></div><div class="layer-close">x</div></div>',callback:function(){if(f){var a=f.split(",");e.init({container:"#__SelectChinaArea",s1:a[0],s2:a[1],s3:a[2]})}else e.init({container:"#__SelectChinaArea",s1:"请选择省份",s2:"请选择市",s3:"请选择县区",val:!1})}}),h={AddressId:"",Area:"",IsDefault:!1,Province:"",City:"",County:"",Addressee:"",DetailAddress:"",PostCode:"",Phone:"",selectAddress:null};return b.prototype={modifyAddress:function(a){return a.Province?a.City?a.County?a.DetailAddress?a.PostCode&&/^\d{6}$/.test(a.PostCode)?a.Addressee?/^[\u4E00-\u9FA5]+$/.test(a.Addressee)?a.Phone&&/^\d{11}$/.test(a.Phone)?(this.tips(),!0):(this.tips("请填写正确手机号码"),!1):(this.tips("收件人必须为中文"),!1):(this.tips("请填写收货人"),!1):(this.tips("请填写正确邮政编码"),!1):(this.tips("请填写详细地址"),!1):(this.tips("请选择县区"),!1):(this.tips("请选择市"),!1):(this.tips("请选择省份"),!1)},tips:function(a){a?$(this.config.tipsCls).html(a).show():$(this.config.tipsCls).hide()},addAddress:function(a,b){var c=this;$.ajax({url:this.config.addressApiHost+this.config.addAddressURL,method:"post",data:a,success:function(a){200==a.Status?b(a.Result):(c.STATUS=0,c.tips(a.Msg||"添加地址失败"))}})},editAddress:function(a,b){var c=this;$.ajax({url:this.config.addressApiHost+this.config.editAddressURL,method:"post",data:a,success:function(a){200==a.Status?b():(c.STATUS=0,c.tips(a.Msg||"编辑地址失败"))}})},deleteAddress:function(a,b){var c=this.getAddressById(a);c&&$.ajax({url:this.config.addressApiHost+this.config.delAddressURL+"?addressid="+a,method:"get",success:function(a){200==a.Status?b():that.tips("删除地址失败")}})},getAllAddress:function(a){$.ajax({url:this.config.getAllAddressURL+"?random="+parseInt(1e3*Math.random()),method:"get",success:function(b){b&&200==b.Status?a(b.Result):that.tips(b.Msg)}})},renderAddressList:function(){for(var a=this.localAddressCache,b=[],c=0,d=a.length;d>c;c++)b.push(this.currentAddressId==a[c].AddressId||-1==this.currentAddressId&&c==d-1?'<li class = "item default"><div class = "action">':'<li class = "item"><div class = "action">'),b.push('<a href="javascript:;" class="edittrigger" AddressId="'+a[c].AddressId+'">修改本地址</a></div><div class="info">'),b.push(a[c].IsDefault?'<input AddressId="'+a[c].AddressId+'" class="radio" id="SELECTEDRADIO_'+c+'" checked type="radio" name="addressItem" />':'<input AddressId="'+a[c].AddressId+'" class="radio" id="SELECTEDRADIO_'+c+'" type="radio" name="addressItem" />'),b.push('<label class="detail" for="SELECTEDRADIO_'+c+'">'+(a[c].IsDefault?'<span class="isDRed">[默认收货地址]</span>':"")+"<span>"+a[c].Area+","+a[c].DetailAddress+"</span><span>&nbsp;&nbsp;邮编："+a[c].PostCode+"</span><span>&nbsp;&nbsp;姓名："+a[c].Addressee+"</span><span>&nbsp;&nbsp;手机："+a[c].Phone+"</span></label></div></li>"),a[c].IsDefault&&$(".userinfo").html(['<p>寄送至：<span class="address">'+a[c].Area+" "+a[c].DetailAddress+"</span></p>",'<p>收件人：<span class="name">'+a[c].Addressee+'</span><span class="phone">'+a[c].Phone+"</span></p>"].join(""));this.container.html(b.join("")),this.localAddressCache.length>=5?this.addTrigger.hide():this.addTrigger.show()},init:function(){var a=this.config,b=this;this.addTrigger=$(a.addCls),this.editTrigger=$(a.editCls),this.localAddressCache=[],this.STATUS=0,b.getAllAddress(function(a){b.localAddressCache=a;for(var c=0,d=a.length;d>c;c++)a[c].IsDefault&&(b.currentAddressId=a[c].AddressId,$(b.config.importAddrssCls).val(a[c].AddressId));b._parseAddress(),b.renderAddressList()}),$("#___SubmitAddress").live("click",function(){function a(a){c||"number"!=typeof a||(d.AddressId=a,b.localAddressCache.push(d));for(var e=d.IsDefault,f=0,h=b.localAddressCache.length;h>f;f++)e&&b.localAddressCache[f].AddressId!=d.AddressId&&(b.localAddressCache[f].IsDefault=!1),b.localAddressCache[f].AddressId==d.AddressId&&(b.localAddressCache[f]=d);$(b.config.importAddrssCls).val(d.AddressId),b.renderAddressList(),b.config.selectAddress&&b.config.selectAddress.call(b,d),this.STATUS=0,g.close()}var c=$(this).attr("AddressId"),d=b.createAddress();if(!b.STATUS){if(!b.modifyAddress(d))return!1;d.AddressId?(f=d.Area,b.currentAddressId=parseInt(d.AddressId),b.editAddress(d,a)):(f="",b.currentAddressId=-1,b.addAddress(d,a))}return!1}),this.addTrigger.live("click",function(){return b.editAlert(),!1}),this.editTrigger.live("click",function(){return b.editAlert($(this).attr("AddressId")),!1}),$(this.config.delCls).live("click",function(){var a=$(this).attr("AddressId");return b.deleteAddress(a,function(){for(var c=0;c<b.localAddressCache.length;c++)b.localAddressCache[c].AddressId==a&&(b.localAddressCache.splice(c,1),--c);g.close(),b.renderAddressList()}),!1}),$("#__FloatAddressLayer .layer-close").live("click",function(){return g.close(),!1}),this.container.find('[type="radio"]').live("click",function(){b.container.find(".item").removeClass("default"),$(this).closest(".item").addClass("default");var a=$(this).attr("AddressId"),c=b.getAddressById(a);c&&c.Area&&$(b.config.importAddrssCls).val(a),$(".userinfo").html(['<p>寄送至：<span class="address">'+c.Area+" "+c.DetailAddress+"</span></p>",'<p>收件人：<span class="name">'+c.Addressee+'</span><span class="phone">'+c.Phone+"</span></p>"].join(""))}),this.container.find(".item").live("mouseover",function(){$(this).find(".action").show()}),this.container.find(".item").live("mouseout",function(){$(this).find(".action").hide()})},createAddress:function(){var a=$("#__FloatAddressLayer"),b=a.find('[name="AddressId"').val()||$("#__FloatAddressLayer [name=AddressId]").val(),c=a.find('[name="Province"] option:selected').html(),d=a.find('[name="City"] option:selected').html(),e=a.find('[name="County"] option:selected').html(),f=a.find('[name="Addressee"]').val(),g=a.find('[name="PostCode"]').val(),h=a.find('[name="Phone"]').val(),i=!!a.find('[name="IsDefault"]').attr("checked"),j=a.find('[name="DetailAddress"]').val(),k={Area:[c,d,e].join(","),IsDefault:i,Province:c,City:d,County:e,Addressee:f,DetailAddress:j,PostCode:g,Phone:h};return b&&(k.AddressId=b),k},getAddressById:function(a){for(var b=this.localAddressCache,c=0,d=b.length;d>c;c++)if(b[c].AddressId==a)return b[c]},_parseAddress:function(){for(var a=this.localAddressCache,b=[],c=0,d=a.length;d>c;c++)b=a[c].Area.split(","),a[c].Province=b[0],a[c].City=b[1],a[c].County=b[2]},editAlert:function(a){if(f="",a){var b=this.getAddressById(a);f=b.Area,g.alert(b),b.IsDefault||$('#__FloatAddressLayer [name="IsDefault"]').attr("checked",!1)}else g.alert(h),$('#__FloatAddressLayer [name="IsDefault"]').attr("checked",!1)}},b});